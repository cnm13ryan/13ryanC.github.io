{{/* â”€â”€â”€ 1. mathjax (unchanged) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{ if or .Params.math .Site.Params.math }}
  {{ partial "math.html" . }}
{{ end }}

{{/* â”€â”€â”€ 2. Enable Mermaid globally or per-page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{- $hasMermaid := false }}
{{- if or .Params.mermaid .Site.Params.mermaid }}
  {{- $hasMermaid = true }}
{{- end }}

{{/* â”€â”€â”€ 3. Mermaid + pan-zoom, only when needed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{- if $hasMermaid }}
  <!-- Mermaid and SVG Pan Zoom from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Mermaid with pan-zoom initialization started...');

      /* 0ï¸âƒ£ Wait for fonts to load to prevent text cutoff */
      const waitForFonts = () => {
        return new Promise((resolve) => {
          if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(() => {
              // Additional small delay to ensure fonts are fully applied
              setTimeout(resolve, 100);
            }).catch(() => {
              // Fallback if font loading fails
              setTimeout(resolve, 300);
            });
          } else {
            // Fallback for browsers without Font Loading API
            setTimeout(resolve, 500);
          }
        });
      };

      
      /* 1ï¸âƒ£ Convert code blocks to mermaid divs */
      document.querySelectorAll('pre > code.language-mermaid').forEach(code => {
        const pre = code.parentElement;
        const div = document.createElement('div');
        div.className = 'mermaid';
        div.textContent = code.textContent;
        pre.replaceWith(div);
        console.log('Converted code block to mermaid div');
      });

      /* 2ï¸âƒ£ Initialize and render Mermaid with proper sequencing */
      const initializeMermaid = async () => {
        // Wait for fonts first
        await waitForFonts();
        console.log('Fonts loaded, initializing Mermaid...');
        
        // Initialize Mermaid with font configuration
        mermaid.initialize({ 
          startOnLoad: false, 
          securityLevel: 'loose',
          theme: 'default',
          // Explicit font configuration to prevent cutoff
          fontFamily: 'trebuchet ms, verdana, arial, sans-serif',
          // Enable responsive width for all diagram types
          flowchart: { useMaxWidth: true, htmlLabels: true },
          sequence: { useMaxWidth: true },
          gantt: { useMaxWidth: true },
          class: { useMaxWidth: true },
          state: { useMaxWidth: true },
          journey: { useMaxWidth: true }
        });
        
        // Render all mermaid diagrams and wait for completion
        await mermaid.run({ querySelector: '.mermaid' });
        console.log('Mermaid rendering completed');
        
        // Now attach pan-zoom after rendering is complete
        attachZoom();
      };

      // Start the initialization process
      initializeMermaid();

      /* 3ï¸âƒ£ Pan-zoom attachment function (no longer needs timeout) */
      setTimeout(() => {
        attachZoom();
      }, 500);

      /* 4ï¸âƒ£ Pan-zoom attachment function */
      const attachZoom = () => {
        const svgs = document.querySelectorAll('.mermaid svg');
        console.log(`Found ${svgs.length} SVG diagrams to enhance`);
        
        svgs.forEach((svg, index) => {
          if (svg.dataset.panzoom) {
            console.log(`Diagram ${index + 1} already has pan-zoom`);
            return; // Skip if already initialized
          }
          
          const mermaidContainer = svg.closest('.mermaid');
          
          try {
            // Add fullscreen button
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.innerHTML = 'â›¶';
            fullscreenBtn.className = 'mermaid-fullscreen-btn';
            fullscreenBtn.title = 'Toggle fullscreen';
            fullscreenBtn.onclick = () => toggleFullscreen(mermaidContainer);
            mermaidContainer.appendChild(fullscreenBtn);
            
            // Add pan-zoom functionality
            const panZoomInstance = svgPanZoom(svg, {
              zoomEnabled: true,
              panEnabled: true,
              controlIconsEnabled: true,
              fit: true,
              center: true,
              minZoom: 0.1,
              maxZoom: 20,
              zoomScaleSensitivity: 0.2,
              mouseWheelZoomEnabled: true,
              dblClickZoomEnabled: true,
              beforePan: function(oldPan, newPan) {
                // Allow panning
                return {x: newPan.x, y: newPan.y};
              }
            });
            
            // Store reference for fullscreen toggling
            svg.panZoomInstance = panZoomInstance;
            
            svg.dataset.panzoom = 'initialized';
            console.log(`Pan-zoom successfully added to diagram ${index + 1}`);
            
            // Add keyboard shortcuts
            svg.addEventListener('keydown', (e) => {
              if (e.key === 'r' || e.key === 'R') {
                panZoomInstance.resetZoom();
                panZoomInstance.resetPan();
                console.log('Reset zoom and pan');
              }
              if (e.key === 'f' || e.key === 'F') {
                toggleFullscreen(mermaidContainer);
              }
            });
            
            // Make SVG focusable for keyboard events
            svg.setAttribute('tabindex', '0');
            
          } catch (error) {
            console.error(`Failed to add pan-zoom to diagram ${index + 1}:`, error);
          }
        });
      };
      
      /* 5ï¸âƒ£ Fullscreen toggle function */
      const toggleFullscreen = (container) => {
        const svg = container.querySelector('svg');
        const panZoomInstance = svg ? svg.panZoomInstance : null;
        
        if (container.classList.contains('mermaid-fullscreen')) {
          // Exit fullscreen
          container.classList.remove('mermaid-fullscreen');
          document.body.style.overflow = '';
          
          // Reset and reconfigure pan-zoom for normal size
          if (panZoomInstance) {
            setTimeout(() => {
              panZoomInstance.resize();
              panZoomInstance.fit();
              panZoomInstance.center();
            }, 100);
          }
        } else {
          // Enter fullscreen
          container.classList.add('mermaid-fullscreen');
          document.body.style.overflow = 'hidden';
          
          // Reconfigure pan-zoom for fullscreen
          if (panZoomInstance) {
            setTimeout(() => {
              panZoomInstance.resize();
              panZoomInstance.resetZoom();
              panZoomInstance.resetPan();
            }, 100);
          }
        }
      };
      
      // Close fullscreen on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.mermaid-fullscreen').forEach(container => {
            container.classList.remove('mermaid-fullscreen');
            document.body.style.overflow = '';
          });
        }
      });
      
      // Also try to attach zoom when new content is loaded (for SPA-like behavior)
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.addedNodes.length > 0) {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === 1 && (node.classList.contains('mermaid') || node.querySelector('.mermaid'))) {
                // For dynamically added content, also wait for fonts and proper rendering
                waitForFonts().then(async () => {
                  const targetNode = node.classList.contains('mermaid') ? node : node.querySelector('.mermaid');
                  if (targetNode) {
                    await mermaid.run({ nodes: [targetNode] });
                    setTimeout(() => attachZoom(), 100);
                  }
                });
              }
            });
          }
        });
      });
      
      observer.observe(document.body, { childList: true, subtree: true });
    });
  </script>

  <!-- Font preload to reduce text cutoff issues -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Trebuchet+MS:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Trebuchet+MS:wght@400;700&display=swap"></noscript>
  
  <!-- Fallback font CSS -->
  <style>
    .mermaid { 
      font-family: 'Trebuchet MS', verdana, arial, sans-serif !important; 
    }
  </style>

  <!-- Enhanced CSS for better diagram interaction -->
  <style>
    .mermaid {
      text-align: center;
      margin: 2em 0;
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      padding: 30px;
      background-color: #fafbfc;
      position: relative;
      overflow: hidden;
      /* Make diagrams larger */
      min-height: 400px;
      max-width: 100%;
      /* Break out of content width on larger screens */
    }
    
    /* Make diagrams even larger on bigger screens */
    @media (min-width: 1200px) {
      .mermaid {
        margin-left: -5%;
        margin-right: -5%;
        width: 110%;
      }
    }
    
    .mermaid svg {
      max-width: 100%;
      height: auto;
      cursor: grab;
      outline: none;
    }
    
    .mermaid svg:active {
      cursor: grabbing;
    }
    
    .mermaid svg:focus {
      box-shadow: 0 0 0 2px #0366d6;
    }
    
    /* Control icons styling */
    .svg-pan-zoom-control {
      background: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid #d1d5da !important;
      border-radius: 3px !important;
    }
    
    .svg-pan-zoom-control:hover {
      background: rgba(255, 255, 255, 1) !important;
      border-color: #0366d6 !important;
    }
    
    /* Fullscreen button */
    .mermaid-fullscreen-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #d1d5da;
      border-radius: 4px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 14px;
      z-index: 10;
      transition: all 0.2s ease;
    }
    
    .mermaid-fullscreen-btn:hover {
      background: rgba(255, 255, 255, 1);
      border-color: #0366d6;
      transform: scale(1.1);
    }
    
    /* Fullscreen mode */
    .mermaid-fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      margin: 0 !important;
      z-index: 9999 !important;
      background: #fafbfc !important;
      border-radius: 0 !important;
      border: none !important;
      padding: 20px !important;
      /* Remove flex centering to allow full space usage */
      display: block !important;
      overflow: hidden !important;
    }
    
    .mermaid-fullscreen svg {
      /* Allow SVG to use full available space */
      width: 100% !important;
      height: calc(100vh - 40px) !important;
      max-width: none !important;
      max-height: none !important;
      object-fit: contain;
    }
    
    /* Add a subtle hint for users */
    .mermaid::after {
      content: "ðŸ’¡ Drag to pan, scroll to zoom, 'R' to reset, 'F' for fullscreen";
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 11px;
      color: #6a737d;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .mermaid:hover::after {
      opacity: 1;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .mermaid {
        background-color: #161b22;
        border-color: #30363d;
      }
      
      .mermaid-fullscreen {
        background: #161b22 !important;
      }
      
      .mermaid-fullscreen-btn {
        background: rgba(22, 27, 34, 0.9);
        border-color: #30363d;
        color: #f0f6fc;
      }
      
      .mermaid-fullscreen-btn:hover {
        background: rgba(22, 27, 34, 1);
        border-color: #58a6ff;
      }
      
      .mermaid::after {
        color: #8b949e;
        background: rgba(22, 27, 34, 0.8);
      }
      
      .svg-pan-zoom-control {
        background: rgba(22, 27, 34, 0.9) !important;
        border-color: #30363d !important;
        color: #f0f6fc !important;
      }
      
      .svg-pan-zoom-control:hover {
        background: rgba(22, 27, 34, 1) !important;
        border-color: #58a6ff !important;
      }
    }
    
    /* Responsive behavior */
    @media (max-width: 768px) {
      .mermaid {
        padding: 10px;
      }
      
      .mermaid::after {
        display: none;
      }
    }
  </style>
{{- end }}
